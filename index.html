<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Waste Management System</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; }
        .header { background: rgba(255,255,255,0.95); padding:1rem 2rem; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; justify-content: space-between; align-items:center; backdrop-filter: blur(10px); position: sticky; top:0; z-index:1000; }
        .logo { display:flex; align-items:center; gap:1rem; }
        .logo i { font-size:2rem; color:#2e7d32; }
        .logo h1 { color:#2e7d32; font-weight:700; }
        .header-actions { display:flex; gap:1rem; }
        .main-container { display:grid; grid-template-columns: 380px 1fr; height:calc(100vh - 80px); gap:1rem; padding:1rem; }
        .sidebar { background: rgba(255,255,255,0.95); border-radius:15px; padding:1.5rem; box-shadow:0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); overflow-y:auto; }
        .map-container { background: rgba(255,255,255,0.95); border-radius:15px; padding:1rem; box-shadow:0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        #map { width:100%; height:100%; border-radius:10px; }
        .section-title { font-size:1.1rem; font-weight:600; color:#2e7d32; margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem; }
        .btn { padding:0.6rem 1rem; border:none; border-radius:8px; font-size:0.95rem; font-weight:600; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; gap:.5rem; text-decoration:none; }
        .btn-primary { background: linear-gradient(45deg,#2e7d32,#4caf50); color:white; }
        .btn-secondary { background:#f5f5f5; color:#666; }
        .btn-success { background: linear-gradient(45deg,#4caf50,#66bb6a); color:white; }
        .btn-danger { background: linear-gradient(45deg,#f44336,#ef5350); color:white; }
        .btn-warning { background: linear-gradient(45deg,#ff9800,#ffb74d); color:white; }
        .btn-info { background: linear-gradient(45deg,#2196F3,#64b5f6); color:white; }
        .btn-small { padding:.35rem .6rem; font-size:.8rem; }
        .btn-full { width:100%; justify-content:center; }
        .form-group { margin-bottom:1rem; }
        .form-group label { display:block; margin-bottom:.5rem; font-weight:600; color:#333; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:.6rem; border:2px solid #e1e5e9; border-radius:8px; font-size:1rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:#2e7d32; }
        .tabs { display:flex; margin-bottom:1rem; border-bottom:2px solid #f0f0f0; gap:.5rem; flex-wrap:wrap; }
        .tab { padding:.6rem .9rem; background:none; border:none; cursor:pointer; font-weight:600; color:#666; border-bottom:3px solid transparent; transition:all .2s; border-radius:6px 6px 0 0; }
        .tab.active { color:#2e7d32; border-bottom-color:#2e7d32; background:rgba(46,125,50,0.05); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .excel-data-table { width:100%; border-collapse:collapse; margin-top:1rem; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        .excel-data-table th, .excel-data-table td { padding:.6rem; text-align:left; border-bottom:1px solid #e0e0e0; }
        .excel-data-table th { background:#f5f5f5; font-weight:600; color:#333; }
        .sync-indicator { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; background:#e8f5e8; border-radius:20px; font-size:.8rem; color:#2e7d32; }
        .sync-indicator.syncing { background:#fff8e1; color:#f57c00; }
        .bin-item { background:#f8f9fa; padding:1rem; margin-bottom:.5rem; border-radius:8px; border-left:4px solid; transition:transform .2s; }
        .bin-item.full { border-left-color:#2196F3; }
        .bin-item.empty { border-left-color:#9E9E9E; }
        .bin-item.faulty { border-left-color:#F44336; }
        .bin-item.segregated { border-left-color:#9C27B0; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color:white; margin:5% auto; padding:2rem; border-radius:15px; width:90%; max-width:900px; box-shadow:0 10px 40px rgba(0,0,0,0.2); max-height:80vh; overflow-y:auto; }
        .close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; line-height:1; }
        .close:hover { color:#333; }
        .alert { padding:1rem; border-radius:8px; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
        .alert-info { background:#cce7ff; color:#004085; border-left:4px solid #007bff; }
        .alert-success { background:#d4edda; color:#155724; border-left:4px solid #28a745; }
        .alert-warning { background:#fff3cd; color:#856404; border-left:4px solid #ffc107; }
        .stat-card { background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; }
        .stat-number { font-size:1.3rem; font-weight:bold; color:#2e7d32; }
        .stat-label { font-size:.8rem; color:#666; margin-top:.25rem; }
        .waste-type-tag { display:inline-block; padding:2px 8px; border-radius:12px; font-size:0.75rem; margin:2px; }
        .waste-organic { background:#8BC34A; color:white; }
        .waste-plastic { background:#2196F3; color:white; }
        .waste-paper { background:#FFC107; color:black; }
        .waste-glass { background:#4CAF50; color:white; }
        .waste-metal { background:#607D8B; color:white; }
        .waste-fabric { background:#9C27B0; color:white; }
        .optimization-card { background:white; padding:1rem; border-radius:8px; margin:1rem 0; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        .optimization-good { border-left:4px solid #4CAF50; }
        .optimization-poor { border-left:4px solid #F44336; }
        .optimization-moderate { border-left:4px solid #FF9800; }
        .checkbox-group { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem; }
        .checkbox-label { display:flex; align-items:center; gap:0.25rem; cursor:pointer; }
        .segregation-badge { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:12px; background:#9C27B0; color:white; font-size:0.75rem; }
        .dumpsite-item { background:#f8f9fa; padding:.8rem; margin-bottom:.5rem; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
        .due-date-warning { background:#fff3cd; border-left:4px solid #ffc107; }
        .due-date-critical { background:#f8d7da; border-left:4px solid #dc3545; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-full { background: #e3f2fd; color: #1976d2; }
        .status-empty { background: #f5f5f5; color: #757575; }
        .status-faulty { background: #ffebee; color: #d32f2f; }
        @media (max-width:768px) {
            .main-container { grid-template-columns:1fr; grid-template-rows:auto 1fr; }
            .sidebar { max-height:300px; }
            .data-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 1200px) {
            .main-container { grid-template-columns: 300px 1fr; }
        }
        @media (max-width: 992px) {
            .main-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .sidebar { max-height: 400px; overflow-y: auto; }
        }
        /* Scrollbar styling */
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .sidebar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .file-upload-area:hover { background: #f0f7f0; transition: background 0.3s; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <i class="fas fa-recycle"></i>
            <h1>Smart Waste Management</h1>
        </div>
        <div class="header-actions">
            <button class="btn btn-info" onclick="downloadSampleTemplate()"><i class="fas fa-file-download"></i> Template</button>
            <button class="btn btn-secondary" onclick="showExcelImportModal()"><i class="fas fa-upload"></i> Import Data</button>
            <button class="btn btn-success" onclick="exportAllDataToExcel()"><i class="fas fa-download"></i> Export All Data</button>
            <div class="sync-indicator" id="syncIndicator"><i class="fas fa-sync"></i> Synced</div>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('data', this)">Excel Data</button>
                <button class="tab" onclick="switchTab('bins', this)">Bin Management</button>
                <button class="tab" onclick="switchTab('fleet', this)">Fleet & Optimization</button>
                <button class="tab" onclick="switchTab('dumpsites', this)">Dumpsites</button>
            </div>

            <!-- Excel Data Tab -->
            <div id="dataTab" class="tab-content active">
                <div class="section-title"><i class="fas fa-table"></i> Dustbin Owner Database</div>
                <div class="data-stats" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:0.5rem; margin-bottom:1rem;">
                    <div class="stat-card"><div class="stat-number" id="totalOwners">0</div><div class="stat-label">Total Owners</div></div>
                    <div class="stat-card"><div class="stat-number" id="activeBins">0</div><div class="stat-label">Active Bins</div></div>
                    <div class="stat-card"><div class="stat-number" id="segregatedBins">0</div><div class="stat-label">Segregated</div></div>
                </div>

                <button class="btn btn-primary btn-full" onclick="showExcelImportModal()" style="margin-bottom:1rem;"><i class="fas fa-file-upload"></i> Load Data</button>

                <div id="excelPreview" class="excel-preview">
                    <div style="text-align:center; padding:2rem; color:#666;">
                        <i class="fas fa-file-excel" style="font-size:3rem; margin-bottom:1rem;"></i>
                        <p>No data loaded</p>
                        <p style="font-size:.9rem;">Import your data file to view information</p>
                    </div>
                </div>
            </div>

            <!-- Bin Management Tab -->
            <div id="binsTab" class="tab-content">
                <div class="section-title"><i class="fas fa-plus-circle"></i> Add New Bin</div>
                <form id="binForm">
                    <div class="form-group">
                        <label for="binId">Bin ID</label>
                        <input type="text" id="binId" name="binId" required placeholder="e.g., BIN-ACC-001">
                    </div>
                    <div class="form-group">
                        <label for="ownerName">Owner Name</label>
                        <input type="text" id="ownerName" name="ownerName" required placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="digitalAddress">Digital Address</label>
                        <input type="text" id="digitalAddress" name="digitalAddress" required placeholder="GA-123-4567">
                    </div>
                    <div class="form-group">
                        <label for="location">Physical Location</label>
                        <textarea id="location" name="location" required placeholder="Complete address details" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="latitude">Latitude <small style="font-weight:400;">(click map to fill)</small></label>
                        <input type="number" id="latitude" name="latitude" step="any" required placeholder="5.6037">
                    </div>
                    <div class="form-group">
                        <label for="longitude">Longitude <small style="font-weight:400;">(click map to fill)</small></label>
                        <input type="number" id="longitude" name="longitude" step="any" required placeholder="-0.1870">
                    </div>
                    <div class="form-group">
                        <label for="binType">Bin Type</label>
                        <select id="binType" name="binType" required>
                            <option value="">Select bin type</option>
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="industrial">Industrial</option>
                        </select>
                    </div>
                    
                    <!-- Waste Segregation Options -->
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isSegregated" name="isSegregated">
                            This is a Segregated Waste Bin
                        </label>
                    </div>
                    
                    <div class="form-group" id="segregationOptions" style="display:none;">
                        <label>Waste Types Collected (Select up to 6):</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="wasteTypes" value="organic">
                                <span class="waste-type-tag waste-organic">Organic</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="wasteTypes" value="plastic">
                                <span class="waste-type-tag waste-plastic">Plastic</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="wasteTypes" value="paper">
                                <span class="waste-type-tag waste-paper">Paper</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="wasteTypes" value="glass">
                                <span class="waste-type-tag waste-glass">Glass</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="wasteTypes" value="metal">
                                <span class="waste-type-tag waste-metal">Metal</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="wasteTypes" value="fabric">
                                <span class="waste-type-tag waste-fabric">Fabric</span>
                            </label>
                        </div>
                        <small style="color:#666;">Segregated bins have different billing rates based on waste types</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactPhone">Contact Phone</label>
                        <input type="tel" id="contactPhone" name="contactPhone" placeholder="+233-XXX-XXXX">
                    </div>
                    <div class="form-group">
                        <label for="binStatus">Status</label>
                        <select id="binStatus" name="binStatus">
                            <option value="empty">Empty</option>
                            <option value="full">Full</option>
                            <option value="faulty">Faulty</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full"><i class="fas fa-save"></i> Add Bin</button>
                </form>

                <div id="binsList" style="margin-top:1.5rem;">
                    <h4 style="margin-bottom:1rem; color:#333;">Registered Bins</h4>
                </div>
            </div>

            <!-- Fleet & Optimization Tab -->
            <div id="fleetTab" class="tab-content">
                <div class="section-title"><i class="fas fa-truck"></i> Fleet Management & Optimization</div>

                <h4 style="margin-bottom:.5rem;">Add / Edit Truck</h4>
                <form id="truckForm">
                    <div class="form-group">
                        <label for="truckId">Truck ID</label>
                        <input type="text" id="truckId" name="truckId" placeholder="e.g., TRK-001" required>
                    </div>
                    <div class="form-group">
                        <label for="driverName">Driver Name</label>
                        <input type="text" id="driverName" name="driverName" placeholder="Driver">
                    </div>
                    <div class="form-group">
                        <label for="truckStartLat">Start Latitude <small>(click map to fill)</small></label>
                        <input type="number" id="truckStartLat" name="truckStartLat" step="any" placeholder="5.6037">
                    </div>
                    <div class="form-group">
                        <label for="truckStartLng">Start Longitude <small>(click map to fill)</small></label>
                        <input type="number" id="truckStartLng" name="truckStartLng" step="any" placeholder="-0.1870">
                    </div>
                    <div class="form-group">
                        <label for="truckCapacity">Capacity (number of bins)</label>
                        <input type="number" id="truckCapacity" name="truckCapacity" min="1" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="truckFuelCapacity">Fuel Tank Capacity (litres)</label>
                        <input type="number" id="truckFuelCapacity" name="truckFuelCapacity" min="1" value="100" required>
                    </div>
                    <div class="form-group">
                        <label for="truckFuelConsumption">Fuel Consumption (km/litre)</label>
                        <input type="number" id="truckFuelConsumption" name="truckFuelConsumption" min="0.1" step="0.1" value="3" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full"><i class="fas fa-plus-circle"></i> Add / Update Truck</button>
                </form>

                <div style="margin:1rem 0;">
                    <h4 style="margin-bottom:.5rem;">Registered Trucks</h4>
                    <div id="trucksList"></div>
                </div>

                <hr />

                <div style="margin-top:1rem;">
                    <h4 style="margin-bottom:.5rem;">Start Pickup Run with Optimization</h4>
                    <div class="form-group">
                        <label for="activeTruckSelect">Select Active Truck</label>
                        <select id="activeTruckSelect" style="width:100%; padding:.6rem; border-radius:8px; border:2px solid #e1e5e9;"></select>
                    </div>

                    <div class="form-group">
                        <label for="pickupDumpsiteSelect">Select Dumpsite for this Trip</label>
                        <select id="pickupDumpsiteSelect" style="width:100%; padding:.6rem; border-radius:8px; border:2px solid #e1e5e9;">
                            <option value="">-- Select Dumpsite --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pickupMode">Pickup Mode</label>
                        <select id="pickupMode" style="width:100%; padding:.6rem; border-radius:8px; border:2px solid #e1e5e9;">
                            <option value="all_full">All full bins</option>
                            <option value="radius">Bins within radius (km)</option>
                            <option value="selected">Select specific bins</option>
                            <option value="segregated_only">Segregated bins only</option>
                        </select>
                    </div>

                    <div class="form-group" id="radiusGroup" style="display:none;">
                        <label for="radiusKm">Radius (km)</label>
                        <input type="number" id="radiusKm" min="0.1" step="0.1" value="2">
                    </div>

                    <div class="form-group" id="selectedBinsGroup" style="display:none;">
                        <label>Choose bins to pick (checkboxes)</label>
                        <div id="selectBinsContainer" style="max-height:150px; overflow:auto; border:1px solid #e0e0e0; padding:.5rem; border-radius:6px;"></div>
                    </div>

                    <div style="display:flex; gap:.5rem; margin-top:.5rem;">
                        <button class="btn btn-primary" onclick="startOptimizedPickupRun()"><i class="fas fa-play"></i> Start Optimized Run</button>
                        <button class="btn btn-secondary" onclick="clearRoute()"><i class="fas fa-ban"></i> Clear Route</button>
                    </div>

                    <!-- Optimization Analysis Section -->
                    <div id="optimizationAnalysis" style="margin-top:1.5rem; display:none;">
                        <h4 style="margin-bottom:.5rem; color:#2e7d32;"><i class="fas fa-chart-line"></i> Trip Optimization Analysis</h4>
                        <div id="optimizationResults"></div>
                    </div>

                    <div style="margin-top:1rem;">
                        <h4 style="margin-bottom:.5rem;">Last Run Summary</h4>
                        <div id="runSummary" style="background:#f8f9fa; padding:1rem; border-radius:6px; min-height:80px;"></div>
                    </div>
                </div>

                <hr />

                <div style="margin-top:1rem;">
                    <h4 style="margin-bottom:.5rem;">Payments & Due Dates</h4>
                    <div id="paymentsList" style="max-height:160px; overflow:auto; border:1px solid #e0e0e0; padding:.5rem; border-radius:6px;"></div>
                </div>
            </div>

            <!-- Dumpsites Tab -->
            <div id="dumpsitesTab" class="tab-content">
                <div class="section-title"><i class="fas fa-trash-alt"></i> Dumpsite Management</div>
                
                <h4 style="margin-bottom:.5rem;">Add New Dumpsite</h4>
                <form id="dumpsiteForm">
                    <div class="form-group">
                        <label for="newDumpsiteName">Dumpsite Name</label>
                        <input type="text" id="newDumpsiteName" name="newDumpsiteName" placeholder="e.g., Main Dumpsite" required>
                    </div>
                    <div class="form-group">
                        <label for="newDumpsiteLat">Latitude <small>(click map to fill)</small></label>
                        <input type="number" id="newDumpsiteLat" name="newDumpsiteLat" step="any" required placeholder="5.6037">
                    </div>
                    <div class="form-group">
                        <label for="newDumpsiteLng">Longitude <small>(click map to fill)</small></label>
                        <input type="number" id="newDumpsiteLng" name="newDumpsiteLng" step="any" required placeholder="-0.1870">
                    </div>
                    <div class="form-group">
                        <label for="dumpsiteCapacity">Capacity (tons)</label>
                        <input type="number" id="dumpsiteCapacity" name="dumpsiteCapacity" min="1" value="100" required>
                    </div>
                    <div class="form-group">
                        <label for="dumpsiteType">Dumpsite Type</label>
                        <select id="dumpsiteType" name="dumpsiteType" required>
                            <option value="landfill">Landfill</option>
                            <option value="recycling">Recycling Center</option>
                            <option value="transfer">Transfer Station</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full"><i class="fas fa-plus-circle"></i> Add Dumpsite</button>
                </form>

                <div style="margin-top:1.5rem;">
                    <h4 style="margin-bottom:.5rem;">All Dumpsites</h4>
                    <div id="dumpsitesList"></div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div id="excelImportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('excelImportModal')">&times;</span>
            <h3 style="margin-bottom:1rem; color:#2e7d32;"><i class="fas fa-file-excel"></i> Import Data File</h3>
            <div class="alert alert-info"><i class="fas fa-info-circle"></i>
                <div><strong>Supported File Format:</strong><br>Import Excel files exported from this system containing bin, truck, and dumpsite data</div>
            </div>

            <div class="file-upload-area" id="fileUploadArea" style="border:2px dashed #2e7d32; border-radius:10px; padding:2rem; text-align:center; cursor:pointer;">
                <i class="fas fa-cloud-upload-alt" style="font-size:3rem; color:#2e7d32; margin-bottom:1rem;"></i>
                <p><strong>Click to select Excel file</strong> or drag and drop</p>
                <p style="font-size:.9rem; color:#666;">Supports .xlsx, .xls files exported from this system</p>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display:none;">
            </div>

            <div id="filePreview" style="display:none; margin-top:1rem;">
                <h4>File Preview:</h4>
                <div id="previewContent"></div>
                <div style="margin-top:1rem;">
                    <button class="btn btn-primary" onclick="processExcelFile()"><i class="fas fa-check"></i> Import Data</button>
                    <button class="btn btn-secondary" onclick="cancelImport()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal placeholder -->
    <div id="customModalContainer"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>

    <script>
    /******************************************************************
     * Enhanced Waste Management System
     * Features: Multiple Dumpsites, Segregated Bins with Patterns, 
     * Different Bin Sizes, Complete Data Export/Import
     ******************************************************************/

    // --- Data stores (localStorage) ---
    let map;
    let bins = [];
    let excelData = [];
    let markers = [];
    let selectedFile = null;

    // Constants
    const FUEL_PRICE_PER_LITRE = 13; // GH₵ 13 per litre
    
    // Waste types with colors for patterns
    const WASTE_TYPES = {
        'organic': { name: 'Organic', rate: 2.0, color: '#8BC34A' },
        'plastic': { name: 'Plastic', rate: 2.5, color: '#2196F3' },
        'paper': { name: 'Paper', rate: 1.5, color: '#FFC107' },
        'glass': { name: 'Glass', rate: 3.0, color: '#4CAF50' },
        'metal': { name: 'Metal', rate: 4.0, color: '#607D8B' },
        'fabric': { name: 'Fabric', rate: 2.0, color: '#9C27B0' }
    };

    // Tax rates based on bin type (different for each type as requested)
    const TAX_RATES = {
        residential: { normal: 2.0, segregated: 3.0 },
        commercial: { normal: 4.0, segregated: 6.0 }, // 2x residential
        industrial: { normal: 8.0, segregated: 12.0 } // 2x commercial
    };

    // Bin size multipliers on map
    const BIN_SIZE_MULTIPLIERS = {
        residential: 1,
        commercial: 2, // 2x residential size
        industrial: 4  // 2x commercial size (4x residential)
    };

    let trucks = [];
    let dumpsites = []; // Changed from single dumpsite to array
    let routeLayer = null;
    let routeMarkers = [];

    // File path for persistent storage
    const PERSISTENT_FILE_PATH = "C:\\Users\\Public\\Desktop\\waste_management_data.xlsx";

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
        loadAllPersistentData();
        setupEventListeners();
        updateMapMarkers();
        updateStats();
        populateActiveTruckSelect();
        populateDumpsiteSelects();
        
        // Initialize dumpsites with a default one if empty
        if (dumpsites.length === 0) {
            dumpsites.push({
                id: generateId('DMP'),
                name: 'Main Dumpsite',
                lat: 5.6037,
                lng: -0.1870,
                capacity: 100,
                type: 'landfill',
                createdAt: new Date().toISOString(),
                currentUsage: 0
            });
            saveAllData();
            loadDumpsites();
            populateDumpsiteSelects();
        }
    });

    function setupEventListeners() {
        // Toggle segregation options
        document.getElementById('isSegregated').addEventListener('change', function(e) {
            document.getElementById('segregationOptions').style.display = e.target.checked ? 'block' : 'none';
        });
        
        // Handle pickup mode changes
        document.getElementById('pickupMode').addEventListener('change', function(e) {
            const val = e.target.value;
            document.getElementById('radiusGroup').style.display = val === 'radius' ? 'block' : 'none';
            document.getElementById('selectedBinsGroup').style.display = val === 'selected' ? 'block' : 'none';
            if (val === 'selected') renderSelectableBinsList();
        });

        // Bin form submission
        document.getElementById('binForm').addEventListener('submit', function(e){
            e.preventDefault();
            addNewBin();
        });

        // Truck form submission
        document.getElementById('truckForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addOrUpdateTruck();
        });

        // Dumpsite form submission
        document.getElementById('dumpsiteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewDumpsite();
        });

        // Map click for coordinates
        let lastCoordTarget = null;
        ['latitude','longitude','truckStartLat','truckStartLng','newDumpsiteLat','newDumpsiteLng'].forEach(id=>{
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('focus', ()=> lastCoordTarget = id);
            }
        });

        map.on('click', function(e){
            if (lastCoordTarget) {
                document.getElementById(lastCoordTarget).value = e.latlng.lat.toFixed(6);
                if (lastCoordTarget === 'latitude' && !document.getElementById('longitude').value) {
                    document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
                }
                if (lastCoordTarget === 'truckStartLat' && !document.getElementById('truckStartLng').value) {
                    document.getElementById('truckStartLng').value = e.latlng.lng.toFixed(6);
                }
                if (lastCoordTarget === 'newDumpsiteLat' && !document.getElementById('newDumpsiteLng').value) {
                    document.getElementById('newDumpsiteLng').value = e.latlng.lng.toFixed(6);
                }
            } else {
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
            }
        });

        // File upload area event listeners
        document.getElementById('fileUploadArea').addEventListener('click', () => {
            document.getElementById('excelFileInput').click();
        });

        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const previewDiv = document.getElementById('previewContent');
                previewDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-file-excel"></i>
                        <strong>File Selected:</strong> ${selectedFile.name}<br>
                        <small>Size: ${(selectedFile.size / 1024).toFixed(2)} KB</small>
                    </div>
                `;
                document.getElementById('filePreview').style.display = 'block';
            }
        });

        document.getElementById('fileUploadArea').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#2e7d32';
            e.currentTarget.style.background = '#f0f7f0';
        });

        document.getElementById('fileUploadArea').addEventListener('dragleave', (e) => {
            e.currentTarget.style.borderColor = '#2e7d32';
            e.currentTarget.style.background = '';
        });

        document.getElementById('fileUploadArea').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#2e7d32';
            e.currentTarget.style.background = '';
            
            if (e.dataTransfer.files.length) {
                selectedFile = e.dataTransfer.files[0];
                const previewDiv = document.getElementById('previewContent');
                previewDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-file-excel"></i>
                        <strong>File Selected:</strong> ${selectedFile.name}<br>
                        <small>Size: ${(selectedFile.size / 1024).toFixed(2)} KB</small>
                    </div>
                `;
                document.getElementById('filePreview').style.display = 'block';
            }
        });
    }

    function initializeMap() {
        map = L.map('map').setView([5.6037, -0.1870], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    }

    /***********************
     * Data Persistence Functions
     ***********************/
    function loadAllPersistentData() {
        // Try to load from localStorage first
        bins = JSON.parse(localStorage.getItem('wasteBins')) || [];
        excelData = JSON.parse(localStorage.getItem('excelOwnerData')) || [];
        trucks = JSON.parse(localStorage.getItem('wasteTrucks')) || [];
        dumpsites = JSON.parse(localStorage.getItem('wasteDumpsites')) || [];
        
        // Load bins data
        loadBins();
        
        // Load trucks data
        loadTrucks();
        
        // Load dumpsites data
        loadDumpsites();
        
        // Load excel preview
        loadExcelData();
        
        console.log('Data loaded from localStorage:', {
            bins: bins.length,
            trucks: trucks.length,
            dumpsites: dumpsites.length
        });
    }

    function saveAllData() {
        localStorage.setItem('wasteBins', JSON.stringify(bins));
        localStorage.setItem('excelOwnerData', JSON.stringify(excelData));
        localStorage.setItem('wasteTrucks', JSON.stringify(trucks));
        localStorage.setItem('wasteDumpsites', JSON.stringify(dumpsites));
        updateSyncIndicator('success', 'Saved');
    }

    /***********************
     * Segregation Functions
     ***********************/
    function getWasteTypeTags(wasteTypes) {
        if (!wasteTypes || wasteTypes.length === 0) return '';
        return wasteTypes.map(type => {
            const wasteInfo = WASTE_TYPES[type];
            if (wasteInfo) {
                return `<span class="waste-type-tag" style="background:${wasteInfo.color}">${wasteInfo.name}</span>`;
            }
            return '';
        }).join(' ');
    }

    function createSegregatedPatternSVG(wasteTypes, sizeMultiplier = 1) {
        if (!wasteTypes || wasteTypes.length === 0) return '';
        
        const baseSize = 30 * sizeMultiplier;
        const svgSize = baseSize + 10;
        let patternSVG = `<svg width="${svgSize}" height="${svgSize}" viewBox="0 0 ${svgSize} ${svgSize}">`;
        
        // Calculate angle step for lines
        const angleStep = 180 / wasteTypes.length;
        
        wasteTypes.forEach((type, index) => {
            const color = WASTE_TYPES[type]?.color || '#9C27B0';
            const angle = index * angleStep;
            const x1 = svgSize / 2;
            const y1 = 0;
            const x2 = svgSize / 2 + svgSize * Math.cos((angle * Math.PI) / 180);
            const y2 = svgSize / 2 + svgSize * Math.sin((angle * Math.PI) / 180);
            
            patternSVG += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" 
                               stroke="${color}" stroke-width="3" stroke-linecap="round"/>`;
        });
        
        patternSVG += '</svg>';
        return patternSVG;
    }

    function calculateBinRate(bin) {
        let baseRate = TAX_RATES[bin.binType]?.normal || 2.0;
        
        if (bin.isSegregated) {
            baseRate = TAX_RATES[bin.binType]?.segregated || baseRate * 1.5;
            
            // Add premium for each waste type
            if (bin.wasteTypes && bin.wasteTypes.length > 0) {
                let wasteTypePremium = 0;
                bin.wasteTypes.forEach(type => {
                    wasteTypePremium += WASTE_TYPES[type]?.rate || 0;
                });
                baseRate += (wasteTypePremium / bin.wasteTypes.length) * 0.5;
            }
        }
        
        return baseRate;
    }

    /***********************
     * Bin Management
     ***********************/
    function addNewBin() {
        const formData = new FormData(document.getElementById('binForm'));
        const wasteTypes = [];
        document.querySelectorAll('input[name="wasteTypes"]:checked').forEach(cb => {
            wasteTypes.push(cb.value);
        });

        const newBin = {
            binId: sanitizeInput(formData.get('binId')).substring(0, 50),
            ownerName: sanitizeInput(formData.get('ownerName')).substring(0, 100),
            digitalAddress: sanitizeInput(formData.get('digitalAddress')).substring(0, 50),
            phone: sanitizeInput(formData.get('contactPhone')).substring(0, 20),
            location: sanitizeInput(formData.get('location')).substring(0, 200),
            address: sanitizeInput(formData.get('location')).substring(0, 200),
            latitude: parseFloat(formData.get('latitude')),
            longitude: parseFloat(formData.get('longitude')),
            binType: formData.get('binType'),
            status: formData.get('binStatus') || 'empty',
            createdAt: new Date().toISOString(),
            source: 'manual',
            pickupCount: 0,
            paymentDue: 0,
            lastPickupDate: null,
            isSegregated: formData.get('isSegregated') === 'on',
            wasteTypes: wasteTypes
        };

        if (bins.find(b => b.binId === newBin.binId)) { 
            showToast('Bin ID already exists!', 'error'); 
            return; 
        }

        bins.push(newBin);
        
        // Add to excelData for export
        const newOwnerData = { 
            id: generateOwnerId(), 
            ownerName: newBin.ownerName, 
            digitalAddress: newBin.digitalAddress, 
            phone: newBin.phone, 
            location: newBin.location, 
            binId: newBin.binId, 
            latitude: newBin.latitude, 
            longitude: newBin.longitude, 
            binType: newBin.binType,
            isSegregated: newBin.isSegregated,
            wasteTypes: wasteTypes,
            importedAt: new Date().toISOString(), 
            pickupCount: 0, 
            paymentDue: 0,
            lastPickupDate: null
        };
        excelData.push(newOwnerData);

        saveAllData();
        loadBins(); 
        loadExcelData(); 
        updateStats();
        
        document.getElementById('binForm').reset();
        document.getElementById('segregationOptions').style.display = 'none';
        showToast('Bin added successfully!', 'success');
    }

    function loadBins() {
        const binsList = document.getElementById('binsList');
        if (bins.length === 0) {
            binsList.innerHTML = `<h4 style="margin-bottom:1rem; color:#333;">Registered Bins</h4>
                <div style="text-align:center; padding:2rem; color:#666;">
                    <i class="fas fa-trash" style="font-size:2rem; margin-bottom:1rem;"></i>
                    <p>No bins registered yet</p>
                </div>`;
            return;
        }
        
        let html = '<h4 style="margin-bottom:1rem; color:#333;">Registered Bins</h4>';
        
        // Check for due payments
        bins.forEach((bin,index) => {
            const dueStatus = checkPaymentDueStatus(bin);
            const dueClass = dueStatus.isDue ? (dueStatus.isCritical ? 'due-date-critical' : 'due-date-warning') : '';
            const segBadge = bin.isSegregated ? '<span class="segregation-badge"><i class="fas fa-recycle"></i> Segregated</span>' : '';
            const wasteTags = bin.isSegregated && bin.wasteTypes ? getWasteTypeTags(bin.wasteTypes) : '';
            const dueIndicator = dueStatus.isDue ? 
                `<div style="color:${dueStatus.isCritical ? '#dc3545' : '#ffc107'}; font-size:0.8rem; margin-top:0.25rem;">
                    <i class="fas fa-exclamation-triangle"></i> Payment due in ${dueStatus.daysRemaining} days
                </div>` : '';
            
            html += `<div class="bin-item ${bin.isSegregated ? 'segregated' : bin.status} ${dueClass}">
                <div class="bin-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="bin-id">${bin.binId} ${segBadge}</div>
                    <div class="status-badge status-${bin.status}">${bin.status}</div>
                </div>
                <div class="owner-info"><strong>Owner:</strong> ${bin.ownerName || 'N/A'}</div>
                <div class="owner-info"><strong>Type:</strong> ${bin.binType} (${bin.isSegregated ? 'Segregated' : 'Normal'})</div>
                <div class="owner-info"><strong>Digital Address:</strong> ${bin.digitalAddress || 'N/A'}</div>
                ${wasteTags ? `<div class="owner-info"><strong>Waste Types:</strong> ${wasteTags}</div>` : ''}
                <div class="owner-info"><strong>Pickups:</strong> ${bin.pickupCount || 0} (Next payment after ${3 - (bin.pickupCount % 3)} pickups)</div>
                ${dueIndicator}
                <div style="margin-top:.5rem; display:flex; gap:.5rem;">
                    <button class="btn btn-secondary btn-small" onclick="viewOnMap(${index})"><i class="fas fa-map-marker-alt"></i> View</button>
                    <button class="btn btn-secondary btn-small" onclick="editBin(${index})"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn btn-success btn-small" onclick="markBinFull(${index})"><i class="fas fa-arrow-up"></i> Mark Full</button>
                </div>
            </div>`;
        });
        
        binsList.innerHTML = html;
        updateMapMarkers();
    }

    function checkPaymentDueStatus(bin) {
        const PICKUPS_PER_PAYMENT = 3;
        const pickupsSinceLastPayment = bin.pickupCount % PICKUPS_PER_PAYMENT;
        const pickupsNeeded = PICKUPS_PER_PAYMENT - pickupsSinceLastPayment;
        
        // For demo: Assume 1 pickup every 7 days
        const daysPerPickup = 7;
        const daysRemaining = pickupsNeeded * daysPerPickup;
        
        return {
            isDue: pickupsSinceLastPayment === 0 && bin.pickupCount > 0,
            daysRemaining: daysRemaining,
            isCritical: daysRemaining <= 7
        };
    }

    function editBin(index) {
        const bin = bins[index];
        if (!bin) return;
        
        // Populate form with bin data
        document.getElementById('binId').value = bin.binId;
        document.getElementById('ownerName').value = bin.ownerName || '';
        document.getElementById('digitalAddress').value = bin.digitalAddress || '';
        document.getElementById('location').value = bin.location || '';
        document.getElementById('latitude').value = bin.latitude || '';
        document.getElementById('longitude').value = bin.longitude || '';
        document.getElementById('binType').value = bin.binType || 'residential';
        document.getElementById('contactPhone').value = bin.phone || '';
        document.getElementById('binStatus').value = bin.status || 'empty';
        
        // Handle segregation
        const isSegCheck = document.getElementById('isSegregated');
        isSegCheck.checked = bin.isSegregated || false;
        document.getElementById('segregationOptions').style.display = bin.isSegregated ? 'block' : 'none';
        
        // Check waste types
        if (bin.wasteTypes) {
            document.querySelectorAll('input[name="wasteTypes"]').forEach(cb => {
                cb.checked = bin.wasteTypes.includes(cb.value);
            });
        }
        
        // Remove old bin
        bins.splice(index, 1);
        excelData = excelData.filter(o => o.binId !== bin.binId);
        
        // Switch to bin management tab
        document.querySelectorAll('.tab')[1].click();
        showToast('Bin loaded for editing', 'info');
    }

    function markBinFull(index) {
        if (index >= 0 && index < bins.length) {
            bins[index].status = 'full';
            saveAllData();
            loadBins();
            updateMapMarkers();
            showToast('Bin marked as full', 'success');
        }
    }

    function viewOnMap(index) {
        const bin = bins[index];
        if (bin && bin.latitude && bin.longitude) {
            map.setView([bin.latitude, bin.longitude], 15);
            markers.forEach(marker => {
                if (marker.getLatLng().lat === bin.latitude && marker.getLatLng().lng === bin.longitude) {
                    marker.openPopup();
                }
            });
        }
    }

    function updateMapMarkers() {
        // Clear existing markers
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        // Add bin markers with different sizes based on type
        bins.forEach((bin, idx) => {
            if (!bin.latitude || !bin.longitude) return;
            
            const sizeMultiplier = BIN_SIZE_MULTIPLIERS[bin.binType] || 1;
            let iconHtml;
            
            if (bin.isSegregated && bin.wasteTypes && bin.wasteTypes.length > 0) {
                // Create pattern for segregated bins
                iconHtml = createSegregatedPatternSVG(bin.wasteTypes, sizeMultiplier);
            } else {
                // Regular bin icon with size based on type
                const size = 30 * sizeMultiplier;
                const color = bin.status === 'full' ? '#2196f3' : 
                             bin.status === 'faulty' ? '#f44336' : '#9e9e9e';
                iconHtml = `<i class="fas fa-trash" style="color:${color}; font-size:${size}px;"></i>`;
            }
            
            const iconSize = 40 * sizeMultiplier;
            const marker = L.marker([bin.latitude, bin.longitude], {
                icon: L.divIcon({ 
                    html: iconHtml, 
                    iconSize: [iconSize, iconSize], 
                    className: 'bin-marker',
                    iconAnchor: [iconSize/2, iconSize/2]
                })
            }).addTo(map);
            
            // Create popup content
            let popupContent = `<div style="min-width:200px;">
                <h4 style="color:#2e7d32; margin-bottom:10px;">${bin.binId}</h4>`;
            
            if (bin.isSegregated) {
                popupContent += `<p><span class="segregation-badge"><i class="fas fa-recycle"></i> Segregated</span></p>`;
            }
            
            popupContent += `<p><strong>Owner:</strong> ${bin.ownerName || 'N/A'}</p>
                <p><strong>Type:</strong> ${bin.binType} (${sizeMultiplier}x size)</p>
                <p><strong>Status:</strong> <span class="status-badge status-${bin.status}">${bin.status}</span></p>
                <p><strong>Pickups:</strong> ${bin.pickupCount || 0}</p>
                <p><strong>Payment Due:</strong> GH₵${(bin.paymentDue || 0).toFixed(2)}</p>`;
            
            if (bin.isSegregated && bin.wasteTypes && bin.wasteTypes.length > 0) {
                popupContent += `<p><strong>Waste Types:</strong> ${getWasteTypeTags(bin.wasteTypes)}</p>`;
            }
            
            popupContent += `</div>`;
            marker.bindPopup(popupContent);
            markers.push(marker);
        });

        // Add truck markers
        trucks.forEach((truck, index) => {
            if (truck.startLat && truck.startLng) {
                const marker = L.marker([truck.startLat, truck.startLng], {
                    icon: L.divIcon({ 
                        html: `<i class="fas fa-truck" style="color:#4caf50; font-size:24px;"></i>`, 
                        iconSize: [30, 30], 
                        className: 'truck-marker' 
                    })
                }).addTo(map);
                marker.bindPopup(`<div style="min-width:180px;">
                    <strong>${truck.truckId}</strong>
                    <div>Driver: ${truck.driverName || 'N/A'}</div>
                    <div>Capacity: ${truck.capacityBins || truck.capacity || 'N/A'} bins</div>
                    <div>Fuel: ${truck.fuelConsumption || 'N/A'} km/L</div>
                </div>`);
                markers.push(marker);
            }
        });

        // Add dumpsite markers
        dumpsites.forEach((dumpsite, index) => {
            const marker = L.marker([dumpsite.lat, dumpsite.lng], {
                icon: L.divIcon({ 
                    html: `<i class="fas fa-trash-alt" style="color:#8d6e63; font-size:24px;"></i>`, 
                    iconSize: [30, 30], 
                    className: 'dumpsite-marker' 
                })
            }).addTo(map);
            marker.bindPopup(`<div style="min-width:200px;">
                <strong>${dumpsite.name}</strong>
                <div>Type: ${dumpsite.type || 'Landfill'}</div>
                <div>Capacity: ${dumpsite.capacity || 0} tons</div>
                <div style="margin-top:10px;">
                    <button class="btn btn-small btn-primary" onclick="setDumpsiteForTrip(${index})">
                        <i class="fas fa-truck"></i> Use for Trip
                    </button>
                </div>
            </div>`);
            markers.push(marker);
        });
    }

    /***********************
     * Truck Management
     ***********************/
    function addOrUpdateTruck() {
        const fd = new FormData(document.getElementById('truckForm'));
        const truckId = sanitizeInput(fd.get('truckId')).trim().substring(0, 50);
        if (!truckId) { 
            showToast('Truck ID is required', 'error'); 
            return; 
        }
        
        const existing = trucks.find(t => t.truckId === truckId);
        const truckObj = {
            truckId,
            driverName: sanitizeInput(fd.get('driverName')).substring(0, 100),
            startLat: fd.get('truckStartLat') ? parseFloat(fd.get('truckStartLat')) : null,
            startLng: fd.get('truckStartLng') ? parseFloat(fd.get('truckStartLng')) : null,
            capacityBins: parseInt(fd.get('truckCapacity')) || 10,
            fuelCapacity: parseInt(fd.get('truckFuelCapacity')) || 100,
            fuelConsumption: parseFloat(fd.get('truckFuelConsumption')) || 3,
            createdAt: new Date().toISOString()
        };
        
        if (existing) {
            Object.assign(existing, truckObj);
            showToast('Truck updated', 'success');
        } else {
            trucks.push(truckObj);
            showToast('Truck added', 'success');
        }
        
        saveAllData();
        loadTrucks();
        updateMapMarkers();
        populateActiveTruckSelect();
        document.getElementById('truckForm').reset();
    }

    function loadTrucks() {
        const container = document.getElementById('trucksList');
        if (trucks.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#666; padding:1rem;">No trucks registered yet</div>`; 
            return;
        }
        
        let html = '';
        trucks.forEach((t, idx) => {
            html += `<div style="background:#f8f9fa; padding:.8rem; margin-bottom:.5rem; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:700;">${t.truckId} ${t.driverName ? '— '+t.driverName : ''}</div>
                    <div style="font-size:.9rem; color:#666;">
                        Capacity: ${t.capacityBins} bins • Fuel: ${t.fuelCapacity}L • ${t.fuelConsumption} km/L
                    </div>
                </div>
                <div style="display:flex; gap:.4rem;">
                    <button class="btn btn-secondary btn-small" onclick="viewTruckOnMap(${idx})">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="btn btn-primary btn-small" onclick="selectTruckForEdit(${idx})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deleteTruck(${idx})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function viewTruckOnMap(index) {
        const truck = trucks[index];
        if (truck && truck.startLat && truck.startLng) {
            map.setView([truck.startLat, truck.startLng], 15);
            markers.forEach(marker => {
                if (marker.getLatLng().lat === truck.startLat && marker.getLatLng().lng === truck.startLng) {
                    marker.openPopup();
                }
            });
        }
    }

    function selectTruckForEdit(index) {
        const truck = trucks[index];
        if (!truck) return;
        
        document.getElementById('truckId').value = truck.truckId;
        document.getElementById('driverName').value = truck.driverName || '';
        document.getElementById('truckStartLat').value = truck.startLat || '';
        document.getElementById('truckStartLng').value = truck.startLng || '';
        document.getElementById('truckCapacity').value = truck.capacityBins || 10;
        document.getElementById('truckFuelCapacity').value = truck.fuelCapacity || 100;
        document.getElementById('truckFuelConsumption').value = truck.fuelConsumption || 3;
        
        // Switch to fleet tab
        document.querySelectorAll('.tab')[2].click();
        showToast('Truck loaded for editing', 'info');
    }

    function deleteTruck(index) {
        if (confirm('Are you sure you want to delete this truck?')) {
            trucks.splice(index, 1);
            saveAllData();
            loadTrucks();
            updateMapMarkers();
            populateActiveTruckSelect();
            showToast('Truck deleted', 'success');
        }
    }

    function populateActiveTruckSelect() {
        const sel = document.getElementById('activeTruckSelect');
        sel.innerHTML = '<option value="">-- Select Truck --</option>';
        trucks.forEach((t, idx) => {
            const opt = document.createElement('option'); 
            opt.value = t.truckId; 
            opt.text = `${t.truckId} ${t.driverName ? ' — '+t.driverName : ''}`; 
            sel.appendChild(opt);
        });
    }

    /***********************
     * Dumpsite Management
     ***********************/
    function addNewDumpsite() {
        const formData = new FormData(document.getElementById('dumpsiteForm'));
        
        const newDumpsite = {
            id: generateId('DMP'),
            name: sanitizeInput(formData.get('newDumpsiteName')).substring(0, 100),
            lat: parseFloat(formData.get('newDumpsiteLat')),
            lng: parseFloat(formData.get('newDumpsiteLng')),
            capacity: parseInt(formData.get('dumpsiteCapacity')) || 100,
            type: formData.get('dumpsiteType'),
            createdAt: new Date().toISOString(),
            currentUsage: 0
        };

        if (!newDumpsite.lat || !newDumpsite.lng) { 
            showToast('Please provide dumpsite coordinates', 'error'); 
            return; 
        }

        dumpsites.push(newDumpsite);
        saveAllData();
        loadDumpsites();
        updateMapMarkers();
        populateDumpsiteSelects();
        
        document.getElementById('dumpsiteForm').reset();
        showToast('Dumpsite added successfully', 'success');
    }

    function loadDumpsites() {
        const container = document.getElementById('dumpsitesList');
        if (dumpsites.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#666; padding:1rem;">No dumpsites registered yet</div>`; 
            return;
        }
        
        let html = '';
        dumpsites.forEach((d, idx) => {
            const usagePercent = (d.currentUsage / d.capacity * 100).toFixed(1);
            const usageColor = usagePercent > 90 ? '#f44336' : usagePercent > 70 ? '#ff9800' : '#4caf50';
            
            html += `<div class="dumpsite-item">
                <div>
                    <div style="font-weight:700;">${d.name}</div>
                    <div style="font-size:.9rem; color:#666;">
                        Type: ${d.type} • Capacity: ${d.capacity} tons
                    </div>
                    <div style="font-size:.8rem; margin-top:0.25rem;">
                        Usage: <span style="color:${usageColor}">${usagePercent}%</span>
                    </div>
                </div>
                <div style="display:flex; gap:.4rem;">
                    <button class="btn btn-secondary btn-small" onclick="viewDumpsiteOnMap(${idx})">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deleteDumpsite(${idx})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function viewDumpsiteOnMap(index) {
        const dumpsite = dumpsites[index];
        if (dumpsite) {
            map.setView([dumpsite.lat, dumpsite.lng], 15);
            markers.forEach(marker => {
                if (marker.getLatLng().lat === dumpsite.lat && marker.getLatLng().lng === dumpsite.lng) {
                    marker.openPopup();
                }
            });
        }
    }

    function deleteDumpsite(index) {
        if (confirm('Are you sure you want to delete this dumpsite?')) {
            dumpsites.splice(index, 1);
            saveAllData();
            loadDumpsites();
            updateMapMarkers();
            populateDumpsiteSelects();
            showToast('Dumpsite deleted', 'success');
        }
    }

    function populateDumpsiteSelects() {
        // Populate pickup dumpsite select
        const pickupSel = document.getElementById('pickupDumpsiteSelect');
        pickupSel.innerHTML = '<option value="">-- Select Dumpsite --</option>';
        dumpsites.forEach((d, idx) => {
            const opt = document.createElement('option'); 
            opt.value = d.id; 
            opt.text = `${d.name} (${d.type})`; 
            pickupSel.appendChild(opt);
        });
    }

    function setDumpsiteForTrip(dumpsiteIndex) {
        if (dumpsiteIndex >= 0 && dumpsiteIndex < dumpsites.length) {
            const dumpsite = dumpsites[dumpsiteIndex];
            document.getElementById('pickupDumpsiteSelect').value = dumpsite.id;
            document.querySelectorAll('.tab')[2].click(); // Switch to fleet tab
            showToast(`Selected ${dumpsite.name} for trip`, 'success');
        }
    }

    /***********************
     * Optimization & Pickup Functions
     ***********************/
    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    function toRad(v) { return v * Math.PI / 180; }

    async function startOptimizedPickupRun() {
        const truckId = document.getElementById('activeTruckSelect').value;
        if (!truckId) { 
            showToast('Select an active truck first', 'error'); 
            return; 
        }
        
        const truck = trucks.find(t => t.truckId === truckId);
        if (!truck) { 
            showToast('Selected truck not found', 'error'); 
            return; 
        }
        
        if (!truck.startLat || !truck.startLng) { 
            showToast('Truck start location missing. Click on the map to set start coordinates.', 'error'); 
            return; 
        }
        
        const dumpsiteId = document.getElementById('pickupDumpsiteSelect').value;
        if (!dumpsiteId) { 
            showToast('Select a dumpsite for this trip', 'error'); 
            return; 
        }
        
        const selectedDumpsite = dumpsites.find(d => d.id === dumpsiteId);
        if (!selectedDumpsite) { 
            showToast('Selected dumpsite not found', 'error'); 
            return; 
        }

        const mode = document.getElementById('pickupMode').value;
        let candidateBins = [];

        if (mode === 'all_full') {
            candidateBins = bins.filter(b => b.status === 'full' && b.latitude && b.longitude);
        } else if (mode === 'radius') {
            const radiusKm = parseFloat(document.getElementById('radiusKm').value) || 1;
            candidateBins = bins.filter(b => b.status === 'full' && b.latitude && b.longitude && 
                haversine(truck.startLat, truck.startLng, b.latitude, b.longitude) <= radiusKm);
        } else if (mode === 'selected') {
            const checks = Array.from(document.querySelectorAll('#selectBinsContainer input[type=checkbox]:checked')).map(ch => ch.value);
            candidateBins = bins.filter(b => checks.includes(b.binId) && b.latitude && b.longitude);
        } else if (mode === 'segregated_only') {
            candidateBins = bins.filter(b => b.status === 'full' && b.isSegregated && b.latitude && b.longitude);
        }

        if (candidateBins.length === 0) { 
            showToast('No candidate bins found for this run', 'error'); 
            return; 
        }

        // Optimized route using nearest neighbor
        const capacity = parseInt(truck.capacityBins) || 10;
        const visitedBins = [];
        let current = { lat: truck.startLat, lng: truck.startLng };
        let remainingCapacity = capacity;
        const routePoints = [{ lat: current.lat, lng: current.lng, label: `${truck.truckId} start` }];
        const usedIndices = new Set();

        // Sort by profitability (higher tax rate first)
        candidateBins.sort((a, b) => {
            const aRate = calculateBinRate(a);
            const bRate = calculateBinRate(b);
            return bRate - aRate;
        });

        while (remainingCapacity > 0 && usedIndices.size < candidateBins.length) {
            let bestIdx = -1, bestDist = Infinity;
            for (let i=0; i<candidateBins.length; i++) {
                if (usedIndices.has(i)) continue;
                const b = candidateBins[i];
                const d = haversine(current.lat, current.lng, b.latitude, b.longitude);
                if (d < bestDist) { 
                    bestDist = d; 
                    bestIdx = i; 
                }
            }
            if (bestIdx === -1) break;
            
            const chosen = candidateBins[bestIdx];
            usedIndices.add(bestIdx);
            visitedBins.push(chosen);
            routePoints.push({ lat: chosen.latitude, lng: chosen.longitude, label: chosen.binId });
            current = { lat: chosen.latitude, lng: chosen.longitude };
            remainingCapacity--;
        }

        if (visitedBins.length === 0) { 
            showToast('No bins could be selected for the route', 'error'); 
            return; 
        }

        // Add selected dumpsite to route
        routePoints.push({ 
            lat: selectedDumpsite.lat, 
            lng: selectedDumpsite.lng, 
            label: selectedDumpsite.name 
        });

        // Draw route on map
        drawRoadRoute(routePoints);

        // Calculate optimization metrics
        const optimization = calculateRouteOptimization(truck, routePoints, visitedBins, selectedDumpsite);

        // Display optimization analysis
        displayOptimizationAnalysis(optimization, truck, visitedBins, selectedDumpsite);

        // Simulate pickups and update bin data
        simulatePickups(visitedBins);

        // Update dumpsite usage
        updateDumpsiteUsage(selectedDumpsite, visitedBins.length);

        // Update all data
        saveAllData();
        loadBins();
        loadExcelData();
        loadDumpsites();
        updateStats();
        updatePaymentsList();

        // Show summary
        showRunSummary(truck, visitedBins, optimization, selectedDumpsite);
        showToast(`Pickup run completed with ${optimization.optimizationLevel} optimization`, 'success');
    }

    function calculateRouteOptimization(truck, routePoints, visitedBins, dumpsite) {
        let totalDistance = 0;
        for (let i = 0; i < routePoints.length - 1; i++) {
            totalDistance += haversine(
                routePoints[i].lat, routePoints[i].lng,
                routePoints[i + 1].lat, routePoints[i + 1].lng
            );
        }

        // Calculate fuel consumption and cost
        const fuelUsed = totalDistance / truck.fuelConsumption;
        const fuelCost = fuelUsed * FUEL_PRICE_PER_LITRE;

        // Calculate expected revenue with different tax rates
        let expectedRevenue = 0;
        visitedBins.forEach(bin => {
            const binRate = calculateBinRate(bin);
            expectedRevenue += binRate;
        });

        // Calculate profit
        const profit = expectedRevenue - fuelCost;
        const profitMargin = expectedRevenue > 0 ? (profit / expectedRevenue) * 100 : 0;

        // Determine optimization level
        let optimizationLevel = 'good';
        let optimizationClass = 'optimization-good';
        let optimizationMessage = 'This route is highly profitable';

        if (profitMargin < 20) {
            optimizationLevel = 'moderate';
            optimizationClass = 'optimization-moderate';
            optimizationMessage = 'This route has moderate profitability';
        }
        if (profitMargin < 0) {
            optimizationLevel = 'poor';
            optimizationClass = 'optimization-poor';
            optimizationMessage = 'This route is not profitable';
        }

        // Calculate efficiency metrics
        const binsPerKm = visitedBins.length / totalDistance;
        const revenuePerKm = expectedRevenue / totalDistance;

        return {
            totalDistance: totalDistance.toFixed(2),
            fuelUsed: fuelUsed.toFixed(2),
            fuelCost: fuelCost.toFixed(2),
            expectedRevenue: expectedRevenue.toFixed(2),
            profit: profit.toFixed(2),
            profitMargin: profitMargin.toFixed(2),
            optimizationLevel,
            optimizationClass,
            optimizationMessage,
            binsPerKm: binsPerKm.toFixed(2),
            revenuePerKm: revenuePerKm.toFixed(2),
            visitedBins: visitedBins.length
        };
    }

    function simulatePickups(visitedBins) {
        const PICKUPS_PER_PAYMENT = 3;
        
        visitedBins.forEach(bin => {
            const bi = bins.find(b => b.binId === bin.binId);
            if (bi) {
                // Update bin status
                bi.status = 'empty';
                bi.pickupCount = (bi.pickupCount || 0) + 1;
                bi.lastPickupDate = new Date().toISOString();
                
                // Check if payment is due (every 3 pickups)
                if (bi.pickupCount % PICKUPS_PER_PAYMENT === 0) {
                    const rate = calculateBinRate(bi);
                    bi.paymentDue = (bi.paymentDue || 0) + rate;
                }
            }
        });

        // Update excelData
        excelData.forEach(owner => {
            const b = bins.find(x => x.binId === owner.binId);
            if (b) { 
                owner.pickupCount = b.pickupCount; 
                owner.paymentDue = b.paymentDue || 0;
                owner.lastPickupDate = b.lastPickupDate;
            }
        });
    }

    function updateDumpsiteUsage(dumpsite, binsCollected) {
        // Each bin contributes approximately 0.1 tons of waste
        const wasteAdded = binsCollected * 0.1;
        dumpsite.currentUsage = Math.min(
            dumpsite.currentUsage + wasteAdded,
            dumpsite.capacity
        );
        
        // Find and update in dumpsites array
        const index = dumpsites.findIndex(d => d.id === dumpsite.id);
        if (index !== -1) {
            dumpsites[index].currentUsage = dumpsite.currentUsage;
        }
    }

    /***********************
     * Export/Import Functions
     ***********************/
    function exportAllDataToExcel() {
        updateSyncIndicator('syncing', 'Exporting...');
        
        try {
            // Create workbook with multiple sheets
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Bins Data
            const binsData = bins.map(bin => ({
                'Bin ID': bin.binId,
                'Owner Name': bin.ownerName,
                'Digital Address': bin.digitalAddress,
                'Phone': bin.phone,
                'Location': bin.location,
                'Latitude': bin.latitude,
                'Longitude': bin.longitude,
                'Bin Type': bin.binType,
                'Is Segregated': bin.isSegregated ? 'Yes' : 'No',
                'Waste Types': bin.wasteTypes ? bin.wasteTypes.join(', ') : '',
                'Status': bin.status,
                'Pickup Count': bin.pickupCount || 0,
                'Payment Due': bin.paymentDue || 0,
                'Last Pickup Date': bin.lastPickupDate ? new Date(bin.lastPickupDate).toLocaleDateString() : '',
                'Created Date': new Date(bin.createdAt).toLocaleDateString()
            }));
            const binsWs = XLSX.utils.json_to_sheet(binsData);
            binsWs['!cols'] = [
                {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 30},
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 20},
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 15}
            ];
            XLSX.utils.book_append_sheet(wb, binsWs, 'Bins');
            
            // Sheet 2: Trucks Data
            const trucksData = trucks.map(truck => ({
                'Truck ID': truck.truckId,
                'Driver Name': truck.driverName || '',
                'Start Latitude': truck.startLat,
                'Start Longitude': truck.startLng,
                'Capacity (bins)': truck.capacityBins,
                'Fuel Capacity (L)': truck.fuelCapacity,
                'Fuel Consumption (km/L)': truck.fuelConsumption,
                'Created Date': new Date(truck.createdAt).toLocaleDateString()
            }));
            const trucksWs = XLSX.utils.json_to_sheet(trucksData);
            trucksWs['!cols'] = [
                {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15},
                {wch: 15}, {wch: 15}, {wch: 15}
            ];
            XLSX.utils.book_append_sheet(wb, trucksWs, 'Trucks');
            
            // Sheet 3: Dumpsites Data
            const dumpsitesData = dumpsites.map(dumpsite => ({
                'Dumpsite ID': dumpsite.id,
                'Name': dumpsite.name,
                'Latitude': dumpsite.lat,
                'Longitude': dumpsite.lng,
                'Type': dumpsite.type,
                'Capacity (tons)': dumpsite.capacity,
                'Current Usage (tons)': dumpsite.currentUsage || 0,
                'Usage %': dumpsite.capacity > 0 ? ((dumpsite.currentUsage || 0) / dumpsite.capacity * 100).toFixed(1) + '%' : '0%',
                'Created Date': new Date(dumpsite.createdAt).toLocaleDateString()
            }));
            const dumpsitesWs = XLSX.utils.json_to_sheet(dumpsitesData);
            dumpsitesWs['!cols'] = [
                {wch: 15}, {wch: 20}, {wch: 12}, {wch: 12}, {wch: 15},
                {wch: 15}, {wch: 15}, {wch: 10}, {wch: 15}
            ];
            XLSX.utils.book_append_sheet(wb, dumpsitesWs, 'Dumpsites');
            
            // Sheet 4: Payments & Due Dates
            const paymentsData = excelData
                .filter(owner => owner.paymentDue > 0)
                .map(owner => {
                    const bin = bins.find(b => b.binId === owner.binId);
                    return {
                        'Owner Name': owner.ownerName,
                        'Bin ID': owner.binId,
                        'Phone': owner.phone,
                        'Digital Address': owner.digitalAddress,
                        'Bin Type': bin?.binType || '',
                        'Is Segregated': bin?.isSegregated ? 'Yes' : 'No',
                        'Pickup Count': owner.pickupCount || 0,
                        'Payment Due (GH₵)': owner.paymentDue || 0,
                        'Last Pickup Date': owner.lastPickupDate ? new Date(owner.lastPickupDate).toLocaleDateString() : '',
                        'Next Payment Pickups': 3 - ((owner.pickupCount || 0) % 3)
                    };
                });
            const paymentsWs = XLSX.utils.json_to_sheet(paymentsData.length > 0 ? paymentsData : [{'Message': 'No outstanding payments'}]);
            paymentsWs['!cols'] = [
                {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12},
                {wch: 12}, {wch: 12}, {wch: 15}, {wch: 15}, {wch: 15}
            ];
            XLSX.utils.book_append_sheet(wb, paymentsWs, 'Payments');
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `waste_management_${timestamp}.xlsx`;
            
            // Save to file
            XLSX.writeFile(wb, filename);
            
            // Also save to persistent location
            try {
                XLSX.writeFile(wb, PERSISTENT_FILE_PATH);
                console.log(`Data also saved to: ${PERSISTENT_FILE_PATH}`);
            } catch (e) {
                console.warn('Could not save to persistent location:', e.message);
            }
            
            updateSyncIndicator('success', 'Exported');
            showToast('All data exported successfully!', 'success');
            
        } catch (error) {
            console.error('Error exporting data:', error);
            updateSyncIndicator('error', 'Export Failed');
            showToast('Error exporting data: ' + error.message, 'error');
        }
        
        setTimeout(() => updateSyncIndicator('success', 'Synced'), 2000);
    }

    function processExcelFile() {
        if (!selectedFile) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                
                // Clear existing data
                bins = [];
                trucks = [];
                dumpsites = [];
                excelData = [];
                
                // Process Bins sheet
                if (workbook.SheetNames.includes('Bins')) {
                    const binsSheet = workbook.Sheets['Bins'];
                    const binsJson = XLSX.utils.sheet_to_json(binsSheet);
                    
                    binsJson.forEach(row => {
                        const wasteTypes = row['Waste Types'] ? 
                            row['Waste Types'].split(',').map(t => t.trim()).filter(t => t) : [];
                        
                        const bin = {
                            binId: row['Bin ID'],
                            ownerName: row['Owner Name'],
                            digitalAddress: row['Digital Address'],
                            phone: row['Phone'],
                            location: row['Location'],
                            address: row['Location'],
                            latitude: parseFloat(row['Latitude']),
                            longitude: parseFloat(row['Longitude']),
                            binType: row['Bin Type'] || 'residential',
                            status: row['Status'] || 'empty',
                            createdAt: new Date().toISOString(),
                            source: 'import',
                            pickupCount: parseInt(row['Pickup Count']) || 0,
                            paymentDue: parseFloat(row['Payment Due']) || 0,
                            isSegregated: row['Is Segregated'] === 'Yes',
                            wasteTypes: wasteTypes,
                            lastPickupDate: row['Last Pickup Date'] || null
                        };
                        bins.push(bin);
                        
                        // Add to excelData
                        excelData.push({
                            id: generateOwnerId(),
                            ...bin
                        });
                    });
                }
                
                // Process Trucks sheet
                if (workbook.SheetNames.includes('Trucks')) {
                    const trucksSheet = workbook.Sheets['Trucks'];
                    const trucksJson = XLSX.utils.sheet_to_json(trucksSheet);
                    
                    trucksJson.forEach(row => {
                        const truck = {
                            truckId: row['Truck ID'],
                            driverName: row['Driver Name'],
                            startLat: parseFloat(row['Start Latitude']),
                            startLng: parseFloat(row['Start Longitude']),
                            capacityBins: parseInt(row['Capacity (bins)']) || 10,
                            fuelCapacity: parseInt(row['Fuel Capacity (L)']) || 100,
                            fuelConsumption: parseFloat(row['Fuel Consumption (km/L)']) || 3,
                            createdAt: new Date().toISOString()
                        };
                        trucks.push(truck);
                    });
                }
                
                // Process Dumpsites sheet
                if (workbook.SheetNames.includes('Dumpsites')) {
                    const dumpsitesSheet = workbook.Sheets['Dumpsites'];
                    const dumpsitesJson = XLSX.utils.sheet_to_json(dumpsitesSheet);
                    
                    dumpsitesJson.forEach(row => {
                        const dumpsite = {
                            id: row['Dumpsite ID'] || generateId('DMP'),
                            name: row['Name'],
                            lat: parseFloat(row['Latitude']),
                            lng: parseFloat(row['Longitude']),
                            type: row['Type'] || 'landfill',
                            capacity: parseInt(row['Capacity (tons)']) || 100,
                            currentUsage: parseFloat(row['Current Usage (tons)']) || 0,
                            createdAt: new Date().toISOString()
                        };
                        dumpsites.push(dumpsite);
                    });
                }
                
                // Save all data
                saveAllData();
                
                // Update UI
                loadBins();
                loadTrucks();
                loadDumpsites();
                loadExcelData();
                updateMapMarkers();
                populateActiveTruckSelect();
                populateDumpsiteSelects();
                updateStats();
                updatePaymentsList();
                
                closeModal('excelImportModal');
                showToast('Data imported successfully!', 'success');
                
            } catch (error) {
                console.error('Error processing file:', error);
                showToast('Error processing file. Please check the format.', 'error');
            }
        };
        
        reader.readAsBinaryString(selectedFile);
    }

    /***********************
     * UI Helper Functions
     ***********************/
    function updateStats() {
        document.getElementById('totalOwners').textContent = excelData.length;
        document.getElementById('activeBins').textContent = bins.filter(b => b.status !== 'faulty').length;
        document.getElementById('segregatedBins').textContent = bins.filter(b => b.isSegregated).length;
    }

    function updatePaymentsList() {
        const cont = document.getElementById('paymentsList');
        const ownersWithPayments = excelData.filter(o => o.paymentDue && o.paymentDue > 0);
        
        if (!ownersWithPayments.length) { 
            cont.innerHTML = '<div style="color:#666; text-align:center; padding:1rem;">No outstanding payments</div>'; 
            return; 
        }
        
        let html = '';
        ownersWithPayments.forEach(o => {
            const bin = bins.find(b => b.binId === o.binId);
            const segBadge = bin?.isSegregated ? 
                '<span class="segregation-badge" style="margin-left:5px;"><i class="fas fa-recycle"></i></span>' : '';
            
            html += `<div style="background:#fff3cd; padding:.5rem; margin-bottom:.4rem; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong>${o.ownerName}</strong> (${o.binId}) ${segBadge}<br>
                    <small>Due: GH₵${(o.paymentDue||0).toFixed(2)} • Pickups: ${o.pickupCount || 0}</small>
                </div>
                <div style="display:flex; gap:.4rem;">
                    <button class="btn btn-success btn-small" onclick="recordPayment('${o.binId}')">
                        <i class="fas fa-money-bill-wave"></i> Record
                    </button>
                </div>
            </div>`;
        });
        cont.innerHTML = html;
    }

    function recordPayment(binId) {
        const binIndex = bins.findIndex(b => b.binId === binId);
        const ownerIndex = excelData.findIndex(o => o.binId === binId);
        
        if (binIndex !== -1) {
            bins[binIndex].paymentDue = 0;
        }
        
        if (ownerIndex !== -1) {
            excelData[ownerIndex].paymentDue = 0;
        }
        
        saveAllData();
        updatePaymentsList();
        loadBins();
        loadExcelData();
        showToast('Payment recorded successfully', 'success');
    }

    function displayOptimizationAnalysis(optimization, truck, visitedBins, dumpsite) {
        const container = document.getElementById('optimizationResults');
        const analysisDiv = document.getElementById('optimizationAnalysis');
        
        let html = `<div class="optimization-card ${optimization.optimizationClass}">
            <h5 style="margin-top:0; display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fas fa-chart-bar"></i> ${optimization.optimizationMessage}</span>
                <span style="font-size:1.2rem; font-weight:bold; color:${optimization.optimizationLevel === 'good' ? '#4CAF50' : 
                    optimization.optimizationLevel === 'moderate' ? '#FF9800' : '#F44336'}">
                    ${optimization.profitMargin}% Margin
                </span>
            </h5>
            
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; margin:1rem 0;">
                <div>
                    <div style="font-size:0.9rem; color:#666;">Total Distance</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${optimization.totalDistance} km</div>
                </div>
                <div>
                    <div style="font-size:0.9rem; color:#666;">Fuel Cost</div>
                    <div style="font-size:1.5rem; font-weight:bold;">GH₵${optimization.fuelCost}</div>
                </div>
                <div>
                    <div style="font-size:0.9rem; color:#666;">Expected Revenue</div>
                    <div style="font-size:1.5rem; font-weight:bold; color:#4CAF50;">GH₵${optimization.expectedRevenue}</div>
                </div>
                <div>
                    <div style="font-size:0.9rem; color:#666;">Profit</div>
                    <div style="font-size:1.5rem; font-weight:bold; color:${optimization.profit >= 0 ? '#4CAF50' : '#F44336'}">
                        GH₵${optimization.profit}
                    </div>
                </div>
            </div>
            
            <div style="margin-top:1rem;">
                <div><strong>Route Details:</strong></div>
                <div style="font-size:0.9rem;">• Truck: ${truck.truckId}</div>
                <div style="font-size:0.9rem;">• Dumpsite: ${dumpsite.name}</div>
                <div style="font-size:0.9rem;">• Bins to collect: ${optimization.visitedBins}</div>
                <div style="font-size:0.9rem;">• Bins per km: ${optimization.binsPerKm}</div>
                <div style="font-size:0.9rem;">• Revenue per km: GH₵${optimization.revenuePerKm}</div>
            </div>`;
            
        container.innerHTML = html;
        analysisDiv.style.display = 'block';
    }

    function showRunSummary(truck, visitedBins, optimization, dumpsite) {
        const summaryEl = document.getElementById('runSummary');
        
        let segregatedCount = visitedBins.filter(b => b.isSegregated).length;
        let residentialCount = visitedBins.filter(b => b.binType === 'residential').length;
        let commercialCount = visitedBins.filter(b => b.binType === 'commercial').length;
        let industrialCount = visitedBins.filter(b => b.binType === 'industrial').length;
        
        const summaryHtml = `
            <div><strong>Truck:</strong> ${truck.truckId}</div>
            <div><strong>Dumpsite:</strong> ${dumpsite.name}</div>
            <div><strong>Bins Collected:</strong> ${visitedBins.length}</div>
            <div><strong>Segregated Bins:</strong> ${segregatedCount}</div>
            <div><strong>Bin Types:</strong> Residential: ${residentialCount}, Commercial: ${commercialCount}, Industrial: ${industrialCount}</div>
            <div><strong>Total Distance:</strong> ${optimization.totalDistance} km</div>
            <div><strong>Fuel Cost:</strong> GH₵${optimization.fuelCost}</div>
            <div><strong>Expected Revenue:</strong> GH₵${optimization.expectedRevenue}</div>
            <div><strong>Profit:</strong> GH₵${optimization.profit} (${optimization.profitMargin}% margin)</div>
            <div><strong>Optimization:</strong> <span style="color:${optimization.optimizationLevel === 'good' ? '#4CAF50' : 
                optimization.optimizationLevel === 'moderate' ? '#FF9800' : '#F44336'}">
                ${optimization.optimizationLevel.toUpperCase()}
            </span></div>
        `;
        
        summaryEl.innerHTML = summaryHtml;
    }

    /***********************
     * Utility Functions
     ***********************/
    function generateId(prefix) {
        return prefix + '-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    function generateOwnerId() {
        return generateId('OWN');
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}`;
        toast.style.cssText = 'position:fixed; top:20px; right:20px; z-index:10000; min-width:300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
            <span style="margin-left:.5rem;">${message}</span>
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity .3s';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function updateSyncIndicator(status, text) {
        const indicator = document.getElementById('syncIndicator');
        indicator.className = 'sync-indicator';
        if (status === 'syncing') { 
            indicator.classList.add('syncing'); 
            indicator.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${text}`; 
        } else if (status === 'success') {
            indicator.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
        } else if (status === 'error') {
            indicator.innerHTML = `<i class="fas fa-times-circle"></i> ${text}`;
        }
    }

    function sanitizeInput(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /***********************
     * Modal Functions
     ***********************/
    function showExcelImportModal() {
        document.getElementById('excelImportModal').style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        document.getElementById('filePreview').style.display = 'none';
        selectedFile = null;
    }

    function cancelImport() {
        closeModal('excelImportModal');
    }

    /***********************
     * Template Download
     ***********************/
    function downloadSampleTemplate() {
        const wb = XLSX.utils.book_new();
        
        // Sample data for template
        const sampleData = [
            {
                'Bin ID': 'BIN-001',
                'Owner Name': 'John Doe',
                'Digital Address': 'GA-123-456',
                'Phone': '+233-123-4567',
                'Location': 'Accra Central',
                'Latitude': 5.6037,
                'Longitude': -0.1870,
                'Bin Type': 'residential',
                'Is Segregated': 'No',
                'Waste Types': '',
                'Status': 'empty',
                'Pickup Count': 0,
                'Payment Due': 0,
                'Last Pickup Date': ''
            }
        ];
        
        const ws = XLSX.utils.json_to_sheet(sampleData);
        XLSX.utils.book_append_sheet(wb, ws, 'Template');
        XLSX.writeFile(wb, 'waste_management_template.xlsx');
        showToast('Template downloaded successfully', 'success');
    }

    /***********************
     * Excel Data Loading
     ***********************/
    function loadExcelData() {
        const preview = document.getElementById('excelPreview');
        if (excelData.length === 0) {
            preview.innerHTML = `
                <div style="text-align:center; padding:2rem; color:#666;">
                    <i class="fas fa-file-excel" style="font-size:3rem; margin-bottom:1rem;"></i>
                    <p>No data loaded</p>
                    <p style="font-size:.9rem;">Import your data file to view information</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <table class="excel-data-table">
                <thead>
                    <tr>
                        <th>Owner</th>
                        <th>Bin ID</th>
                        <th>Address</th>
                        <th>Type</th>
                        <th>Pickups</th>
                        <th>Due</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        excelData.slice(0, 10).forEach(owner => {
            const bin = bins.find(b => b.binId === owner.binId);
            html += `
                <tr>
                    <td>${owner.ownerName || 'N/A'}</td>
                    <td>${owner.binId || 'N/A'}</td>
                    <td>${owner.digitalAddress || 'N/A'}</td>
                    <td>${bin?.binType || 'N/A'} ${bin?.isSegregated ? '<span class="segregation-badge"><i class="fas fa-recycle"></i></span>' : ''}</td>
                    <td>${owner.pickupCount || 0}</td>
                    <td>GH₵${(owner.paymentDue || 0).toFixed(2)}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        
        if (excelData.length > 10) {
            html += `<div style="text-align:center; padding:1rem; color:#666;">
                Showing 10 of ${excelData.length} records
            </div>`;
        }
        
        preview.innerHTML = html;
    }

    /***********************
     * Render selectable bins list
     ***********************/
    function renderSelectableBinsList() {
        const container = document.getElementById('selectBinsContainer');
        let html = '';
        
        bins.forEach((bin, index) => {
            if (bin.status === 'full') {
                const segBadge = bin.isSegregated ? 
                    '<span class="segregation-badge" style="margin-left:5px;"><i class="fas fa-recycle"></i></span>' : '';
                
                html += `
                    <label style="display:block; margin-bottom:0.25rem;">
                        <input type="checkbox" value="${bin.binId}" style="margin-right:5px;">
                        ${bin.binId} ${segBadge} - ${bin.binType} (${bin.ownerName || 'No owner'})
                    </label>
                `;
            }
        });
        
        if (!html) {
            html = '<div style="color:#666; padding:0.5rem; text-align:center;">No full bins available</div>';
        }
        
        container.innerHTML = html;
    }

    /***********************
     * Route Drawing Functions
     ***********************/
    async function drawRoadRoute(points) {
        if (routeLayer) map.removeLayer(routeLayer);
        routeMarkers.forEach(marker => map.removeLayer(marker));
        routeMarkers = [];

        const coordinates = points.map(p => `${p.lng},${p.lat}`).join(';');
        const url = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.code === 'Ok') {
                const routeGeometry = data.routes[0].geometry;
                routeLayer = L.geoJSON(routeGeometry, {
                    style: {
                        color: '#1976D2',
                        weight: 6,
                        opacity: 0.8
                    }
                }).addTo(map);
                
                points.forEach((point, index) => {
                    const marker = L.circleMarker([point.lat, point.lng], {
                        radius: 8,
                        fillColor: index === 0 ? '#4caf50' : 
                                  (index === points.length - 1 ? '#f44336' : '#ff9800'),
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    marker.bindPopup(point.label);
                    routeMarkers.push(marker);
                });
                
                map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
            } else {
                drawStraightRoute(points);
            }
        } catch (error) {
            console.error('Error fetching route:', error);
            drawStraightRoute(points);
        }
    }

    function drawStraightRoute(points) {
        const latlngs = points.map(p => [p.lat, p.lng]);
        routeLayer = L.polyline(latlngs, { 
            color: '#1976D2', 
            weight: 4, 
            opacity: 0.8,
            dashArray: '10, 10'
        }).addTo(map);
        
        points.forEach((point, index) => {
            const marker = L.circleMarker([point.lat, point.lng], {
                radius: 6,
                fillColor: index === 0 ? '#4caf50' : 
                          (index === points.length - 1 ? '#f44336' : '#ff9800'),
                color: '#fff',
                weight: 1
            }).addTo(map).bindPopup(point.label);
            routeMarkers.push(marker);
        });
        
        map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
    }

    function clearRoute() {
        if (routeLayer) { 
            map.removeLayer(routeLayer); 
            routeLayer = null; 
        }
        routeMarkers.forEach(marker => map.removeLayer(marker));
        routeMarkers = [];
        document.getElementById('runSummary').innerHTML = '';
        document.getElementById('optimizationAnalysis').style.display = 'none';
    }

    // Performance optimization for map updates
    let updateTimeout;
    function scheduleMapUpdate() {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            updateMapMarkers();
        }, 500);
    }

    // Tab switching
    function switchTab(tabName, button) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
    }

    // Initialize the application
    setTimeout(() => {
        console.log('Smart Waste Management System initialized');
        console.log('Features:', { 
            multipleDumpsites: '✅', 
            segregatedBinsWithPatterns: '✅', 
            differentBinSizes: '✅', 
            completeDataExport: '✅',
            persistentStorage: '✅'
        });
    }, 2000);
    </script>
</body>
</html>
